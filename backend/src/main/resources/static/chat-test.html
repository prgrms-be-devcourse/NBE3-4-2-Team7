<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>1:1 채팅 테스트 (RabbitMQ)</title>
</head>
<body>
<h1>1:1 채팅 테스트 (RabbitMQ)</h1>

<div>
    <label for="roomId">Room ID:</label>
    <input type="text" id="roomId" value="1" placeholder="채팅방 ID 입력 (예: 1)" required>
</div>

<div>
    <label for="userId">Your User ID:</label>
    <input type="text" id="userId" value="1" placeholder="본인 User ID (1 or 2)" required>
</div>

<div>
    <label for="message">Message:</label>
    <input type="text" id="message" placeholder="메시지 입력" required>
    <button onclick="sendMessage()">Send</button>
</div>

<h3>채팅 로그:</h3>
<div id="chatLog" style="border: 1px solid black; padding: 10px; height: 300px; overflow-y: scroll;"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

<script>
    let stompClient;

    // WebSocket 연결 설정
    function connect() {
        const socket = new SockJS('/chat');  // 서버의 WebSocket 엔드포인트
        stompClient = Stomp.over(socket);

        stompClient.connect({}, function (frame) {
            console.log('Connected: ' + frame);
            alert("WebSocket 연결 성공");

            const roomId = document.getElementById('roomId').value;
            if (!roomId) {
                alert('Room ID를 입력해주세요.');
                return;
            }

            // 특정 채팅방의 메시지를 수신하는 경로 (/exchange/chat.exchange/chat.room.{roomId})
            stompClient.subscribe('/exchange/chat.exchange/chat.room.' + roomId, function (message) {
                showMessage(JSON.parse(message.body));
            });
        }, function (error) {
            alert('WebSocket 연결 실패: ' + error);
            console.error('WebSocket 연결 실패:', error);
        });
    }

    // 메시지 전송
    function sendMessage() {
        const roomId = document.getElementById('roomId').value;
        const userId = document.getElementById('userId').value;
        const messageContent = document.getElementById('message').value;

        if (!roomId || !userId || !messageContent) {
            alert('모든 입력 값을 입력해주세요.');
            return;
        }

        const messageDto = {
            roomId: roomId,
            sender: userId,
            toUserId: userId === "1" ? "2" : "1",  // 상대방 ID 설정
            content: messageContent
        };

        stompClient.send(`/pub/chat.message.${roomId}`, {}, JSON.stringify(messageDto));
        document.getElementById('message').value = '';  // 메시지 입력창 초기화
    }

    // 메시지 화면에 표시
    function showMessage(message) {
        const chatLog = document.getElementById('chatLog');
        const newMessage = `<p><strong>User ${message.sender}:</strong> ${message.content}</p>`;
        chatLog.innerHTML += newMessage;
        chatLog.scrollTop = chatLog.scrollHeight;  // 자동 스크롤
    }

    // 페이지 로드 시 WebSocket 연결
    window.onload = connect;
</script>
</body>
</html>
